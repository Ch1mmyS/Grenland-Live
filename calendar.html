<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kalender ‚Äì Grenland Live</title>
  <style>
    :root{
      --bg:#f6f8ff;
      --panel:#ffffff;
      --text:#0b1220;
      --muted:rgba(11,18,32,.62);
      --line:rgba(11,18,32,.12);
      --accent:#2563eb;
      --accent2:#10b981;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      padding:16px 16px 8px;
      max-width:1200px;
      margin:0 auto;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:0 16px 24px;}
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      box-shadow:0 6px 16px rgba(0,0,0,.05);
    }
    .title{display:flex;flex-direction:column;gap:2px}
    .title h1{margin:0;font-size:18px}
    .title small{color:var(--muted)}
    .controls{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
    }
    button, .btnLink{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      text-decoration:none;
      color:inherit;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    button:hover, .btnLink:hover{border-color:rgba(37,99,235,.35)}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:800;
      min-width:200px;
      justify-content:center;
      text-transform:capitalize;
    }
    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media(min-width:980px){
      .grid{grid-template-columns: 1.2fr .8fr;}
    }
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      box-shadow:0 6px 16px rgba(0,0,0,.05);
    }
    .weekdays{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
      margin-bottom:8px;
      color:var(--muted);
      font-weight:800;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.04em;
    }
    .cal{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
    }
    .day{
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      padding:10px;
      min-height:86px;
      display:flex;
      flex-direction:column;
      gap:8px;
      cursor:pointer;
      position:relative;
    }
    .day:hover{border-color:rgba(37,99,235,.35)}
    .day.muted{opacity:.55;background:rgba(255,255,255,.7)}
    .day.selected{outline:2px solid rgba(37,99,235,.45);border-color:rgba(37,99,235,.45)}
    .dnum{
      font-weight:900;
      font-size:13px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .badge{
      font-size:11px;
      font-weight:900;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(37,99,235,.08);
    }
    .dots{display:flex;gap:6px;flex-wrap:wrap}
    .dot{width:8px;height:8px;border-radius:99px;background:rgba(37,99,235,.75)}
    .dot.ws{background:rgba(16,185,129,.85)}
    .dot.hb{background:rgba(37,99,235,.75)}
    .dot.fb{background:rgba(245,158,11,.90)}
    .legend{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      color:var(--muted);font-size:13px;margin-top:10px;
    }
    .legend span{display:inline-flex;align-items:center;gap:8px;}
    .list h2{margin:0 0 6px;font-size:16px}
    .list small{color:var(--muted)}
    .event{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .event .row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .event .when{font-weight:900}
    .event .meta{color:var(--muted);font-size:13px}
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      font-weight:900;
      font-size:12px;
      background:rgba(11,18,32,.06);
    }
    .tag.fb{background:rgba(245,158,11,.12)}
    .tag.hb{background:rgba(37,99,235,.10)}
    .tag.ws{background:rgba(16,185,129,.10)}
    .empty{color:var(--muted);padding:10px 0}
    .foot{margin-top:10px;color:var(--muted);font-size:12px;}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="title">
        <h1>üìÖ Grenland Live ‚Äì Kalender</h1>
        <small>Alt samlet: fotball + h√•ndball + vintersport + VM 2026 ‚Ä¢ Klikk dag for tid + kanal</small>
      </div>

      <div class="controls">
        <a class="btnLink" href="index.html">‚Üê Tilbake</a>
        <button id="prevBtn" type="button">‚óÄ Forrige</button>
        <div class="pill" id="monthLabel">‚Äì</div>
        <button id="nextBtn" type="button">Neste ‚ñ∂</button>
        <button id="todayBtn" type="button">I dag</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <div class="weekdays">
          <div>Man</div><div>Tir</div><div>Ons</div><div>Tor</div><div>Fre</div><div>L√∏r</div><div>S√∏n</div>
        </div>
        <div class="cal" id="calGrid"></div>

        <div class="legend">
          <span><span class="dot fb"></span> Fotball</span>
          <span><span class="dot hb"></span> H√•ndball</span>
          <span><span class="dot ws"></span> Vintersport</span>
        </div>

        <div class="foot" id="dataStatus">Laster data‚Ä¶</div>
      </div>

      <div class="card list">
        <h2 id="dayTitle">Velg en dag</h2>
        <small id="daySub">‚Äì</small>
        <div id="eventList" class="empty">Klikk en dag i kalenderen for √• se alt som g√•r + kanal.</div>
      </div>
    </div>
  </div>

  <script>
    // ‚úÖ Disse m√• matche filene dine i /data/
    const SOURCES = [
      // Fotball (finnes hos deg allerede)
      { key:"eliteserien", name:"Eliteserien",        url:"data/eliteserien.json",      kind:"football" },
      { key:"obos",       name:"OBOS-ligaen",         url:"data/obos.json",             kind:"football" },
      { key:"premier",    name:"Premier League",     url:"data/premier_league.json",   kind:"football" },
      { key:"cl",         name:"Champions League",   url:"data/champions.json",         kind:"football" },
      { key:"laliga",     name:"La Liga",            url:"data/laliga.json",            kind:"football" },

      // H√•ndball (du har disse, men de er tomme akkurat n√•)
      { key:"hb_menn",    name:"H√•ndball VM 2026 ‚Äì Menn",  url:"data/handball_vm_2026_menn.json",  kind:"handball" },
      { key:"hb_damer",   name:"H√•ndball VM 2026 ‚Äì Damer", url:"data/handball_vm_2026_damer.json", kind:"handball" },

      // Vintersport (du har disse, men de er tomme akkurat n√•)
      { key:"ws_menn",    name:"Vintersport ‚Äì Menn",       url:"data/vintersport_menn.json",       kind:"wintersport" },
      { key:"ws_kvinner", name:"Vintersport ‚Äì Kvinner",    url:"data/vintersport_kvinner.json",    kind:"wintersport" },

      // VM 2026 (egen miks/oversikt)
      { key:"vm2026",     name:"VM kalender 2026",          url:"data/vm2026.json",                 kind:"vm" }
    ];

    const TZ = "Europe/Oslo";

    let allEvents = [];
    let current = startOfMonth(new Date());
    let selectedDate = null;

    const calGrid = document.getElementById("calGrid");
    const monthLabel = document.getElementById("monthLabel");
    const dataStatus = document.getElementById("dataStatus");
    const dayTitle = document.getElementById("dayTitle");
    const daySub = document.getElementById("daySub");
    const eventList = document.getElementById("eventList");

    document.getElementById("prevBtn").addEventListener("click", () => {
      current = addMonths(current, -1);
      selectedDate = null;
      render();
    });
    document.getElementById("nextBtn").addEventListener("click", () => {
      current = addMonths(current, 1);
      selectedDate = null;
      render();
    });
    document.getElementById("todayBtn").addEventListener("click", () => {
      current = startOfMonth(new Date());
      selectedDate = new Date();
      render();
      renderDay(selectedDate);
    });

    function pad2(n){ return String(n).padStart(2,"0"); }
    function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
    function addMonths(d, n){ return new Date(d.getFullYear(), d.getMonth()+n, 1); }
    function isoToDate(iso){ try { return new Date(iso); } catch(e){ return null; } }

    function fmtMonth(d){
      return d.toLocaleString("no-NO", { timeZone: TZ, month:"long", year:"numeric" });
    }
    function fmtDay(d){
      return d.toLocaleString("no-NO", { timeZone: TZ, weekday:"long", day:"2-digit", month:"long", year:"numeric" });
    }
    function fmtTime(iso){
      const d = isoToDate(iso);
      if(!d) return "";
      return d.toLocaleString("no-NO", { timeZone: TZ, hour:"2-digit", minute:"2-digit" });
    }

    function ymd(d){
      const dd = new Date(d.toLocaleString("en-US", { timeZone: TZ }));
      return `${dd.getFullYear()}-${pad2(dd.getMonth()+1)}-${pad2(dd.getDate())}`;
    }

    function monthGridDates(monthStart){
      const first = new Date(monthStart.getFullYear(), monthStart.getMonth(), 1);
      const last = new Date(monthStart.getFullYear(), monthStart.getMonth()+1, 0);

      const firstDow = first.getDay(); // 0..6 (sun=0)
      const offset = (firstDow === 0 ? 6 : firstDow - 1); // back to Monday
      const gridStart = new Date(first);
      gridStart.setDate(first.getDate() - offset);

      const dates = [];
      for(let i=0;i<42;i++){
        const d = new Date(gridStart);
        d.setDate(gridStart.getDate() + i);
        dates.push(d);
      }
      return { dates, first, last };
    }

    function normalizeEntry(raw, source){
      // St√∏tt b√•de "events" og "games" format
      const start = raw.start || raw.kickoff || raw.datetime || raw.dateTime || raw.date;
      if(!start) return null;

      const title =
        raw.title ||
        raw.match ||
        raw.name ||
        ((raw.home && raw.away) ? `${raw.home} ‚Äì ${raw.away}` : null) ||
        "Event";

      const channel = raw.channel || raw.tv || raw.broadcast || raw.kanal || "";
      const league = raw.league || source.name;

      return {
        id: raw.id || `${source.key}-${start}-${title}`.replace(/\s+/g,"-"),
        start,
        title,
        channel,
        kind: source.kind,     // football/handball/wintersport/vm
        league
      };
    }

    function eventsByDayMap(events){
      const map = new Map();
      for(const ev of events){
        const d = isoToDate(ev.start);
        if(!d) continue;
        const key = ymd(d);
        if(!map.has(key)) map.set(key, []);
        map.get(key).push(ev);
      }
      for(const [k, arr] of map.entries()){
        arr.sort((a,b)=> new Date(a.start) - new Date(b.start));
      }
      return map;
    }

    function dotClass(ev){
      if(ev.kind === "wintersport") return "dot ws";
      if(ev.kind === "handball") return "dot hb";
      return "dot fb"; // football + vm som default
    }

    function tag(ev){
      if(ev.kind === "wintersport") return { cls:"tag ws", text:"Vintersport" };
      if(ev.kind === "handball") return { cls:"tag hb", text:"H√•ndball" };
      if(ev.kind === "football") return { cls:"tag fb", text:"Fotball" };
      return { cls:"tag", text:"VM/2026" };
    }

    async function loadAll(){
      const results = [];
      const errors = [];
      let totalRaw = 0;

      for(const s of SOURCES){
        try{
          // cache-buster for GitHub Pages caching
          const url = `${s.url}?v=${Date.now()}`;
          const r = await fetch(url, { cache:"no-store" });
          if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
          const data = await r.json();

          const arr = Array.isArray(data.events) ? data.events : (Array.isArray(data.games) ? data.games : []);
          totalRaw += arr.length;

          for(const raw of arr){
            const ev = normalizeEntry(raw, s);
            if(ev) results.push(ev);
          }
        }catch(err){
          errors.push(`${s.name}: ${err.message}`);
        }
      }

      allEvents = results.sort((a,b)=> new Date(a.start) - new Date(b.start));

      if(errors.length){
        dataStatus.textContent = `‚ö†Ô∏è Noen kilder kunne ikke lastes: ${errors.join(" ‚Ä¢ ")} ‚Ä¢ Lastet ${allEvents.length}/${totalRaw}`;
      }else{
        dataStatus.textContent = `‚úÖ Lastet ${allEvents.length} events (fra ${SOURCES.length} filer)`;
      }
    }

    function render(){
      monthLabel.textContent = fmtMonth(current);

      const { dates, first } = monthGridDates(current);
      const firstMonth = first.getMonth();
      const map = eventsByDayMap(allEvents);

      calGrid.innerHTML = "";

      const todayKey = ymd(new Date());
      const selectedKey = selectedDate ? ymd(selectedDate) : null;

      for(const d of dates){
        const key = ymd(d);
        const isMuted = d.getMonth() !== firstMonth;

        const dayEvents = map.get(key) || [];

        const dotWrap = document.createElement("div");
        dotWrap.className = "dots";
        for(const ev of dayEvents.slice(0,7)){
          const dot = document.createElement("span");
          dot.className = dotClass(ev);
          dotWrap.appendChild(dot);
        }

        const el = document.createElement("div");
        el.className = "day" + (isMuted ? " muted" : "");
        if(key === selectedKey) el.classList.add("selected");

        const top = document.createElement("div");
        top.className = "dnum";

        const left = document.createElement("span");
        left.textContent = String(new Date(d.toLocaleString("en-US", { timeZone: TZ })).getDate());

        const right = document.createElement("span");
        if(dayEvents.length){
          right.className = "badge";
          right.textContent = `${dayEvents.length}`;
        }else if(key === todayKey){
          right.className = "badge";
          right.textContent = "i dag";
        }else{
          right.textContent = "";
        }

        top.appendChild(left);
        top.appendChild(right);

        el.appendChild(top);
        el.appendChild(dotWrap);

        el.addEventListener("click", () => {
          selectedDate = d;
          render();
          renderDay(d);
        });

        calGrid.appendChild(el);
      }

      if(!selectedDate){
        const monthEvents = allEvents.filter(e => {
          const dt = new Date(e.start);
          const oslo = new Date(dt.toLocaleString("en-US", { timeZone: TZ }));
          return oslo.getFullYear() === current.getFullYear() && oslo.getMonth() === current.getMonth();
        });
        if(monthEvents.length){
          selectedDate = new Date(monthEvents[0].start);
          render();
          renderDay(selectedDate);
        }else{
          dayTitle.textContent = "Velg en dag";
          daySub.textContent = "‚Äì";
          eventList.className = "empty";
          eventList.textContent = "Ingen events i denne m√•neden (enn√•).";
        }
      }
    }

    function renderDay(d){
      const key = ymd(d);
      const map = eventsByDayMap(allEvents);
      const dayEvents = map.get(key) || [];

      dayTitle.textContent = fmtDay(d);
      daySub.textContent = dayEvents.length ? `${dayEvents.length} event(s)` : "Ingen events";

      if(!dayEvents.length){
        eventList.className = "empty";
        eventList.textContent = "Ingen events denne dagen.";
        return;
      }

      eventList.className = "";
      eventList.innerHTML = "";

      for(const ev of dayEvents){
        const card = document.createElement("div");
        card.className = "event";

        const row1 = document.createElement("div");
        row1.className = "row";

        const when = document.createElement("div");
        when.className = "when";
        when.textContent = `üïí ${fmtTime(ev.start)}  ‚Ä¢  ${ev.title}`;

        const tg = tag(ev);
        const t = document.createElement("div");
        t.className = tg.cls;
        t.textContent = tg.text;

        row1.appendChild(when);
        row1.appendChild(t);

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent =
          `${ev.league ? "üè∑Ô∏è " + ev.league + "  ‚Ä¢  " : ""}` +
          (ev.channel ? `üì∫ ${ev.channel}` : "üì∫ Kanal: ikke oppgitt");

        card.appendChild(row1);
        card.appendChild(meta);
        eventList.appendChild(card);
      }
    }

    (async function init(){
      await loadAll();
      render();
    })();
  </script>
</body>
</html>
