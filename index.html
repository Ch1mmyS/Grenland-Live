<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Grenland Live</title>
  <style>
    :root{
      --bg:#f6f8ff;
      --panel:#ffffff;
      --card:#ffffff;
      --text:#0b1220;
      --muted:rgba(11,18,32,0.62);
      --line:rgba(11,18,32,0.10);
      --shadow:0 10px 30px rgba(11,18,32,0.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:22px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);
      padding:14px 16px;box-shadow:var(--shadow);
      position:sticky;top:10px;z-index:5;
    }
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand h1{margin:0;font-size:18px;line-height:1.2}
    .brand .sub{color:var(--muted);font-size:12px}
    .status{
      font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(11,18,32,0.04);white-space:nowrap;
    }
    .status.online{border-color:rgba(16,185,129,0.35);background:rgba(16,185,129,0.10)}
    .status.offline{border-color:rgba(239,68,68,0.35);background:rgba(239,68,68,0.10)}

    .controls{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:flex-end;
    }
    .ctrl{
      display:flex;flex-direction:column;gap:6px;min-width:180px;
    }
    label{font-size:12px;color:var(--muted)}
    select,input{
      border:1px solid var(--line);background:var(--card);color:var(--text);
      border-radius:12px;padding:10px 12px;font-size:14px;outline:none;
    }
    input{min-width:220px}
    .btn{
      border:1px solid var(--line);background:var(--card);color:var(--text);
      border-radius:12px;padding:10px 12px;font-size:14px;cursor:pointer;
    }
    .btn:hover{filter:brightness(0.98)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:16px}
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
      padding:14px 14px;box-shadow:var(--shadow);
    }
    .rowTop{display:flex;gap:10px;align-items:flex-start;justify-content:space-between}
    .title{
      display:flex;flex-direction:column;gap:4px;min-width:0;
    }
    .league{font-weight:800;font-size:14px}
    .teams{font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta{
      display:flex;flex-direction:column;gap:8px;align-items:flex-end;text-align:right;
      min-width:220px;
    }
    .metaLine{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
    }
    .metaLabel{font-weight:700;opacity:0.9}
    .muted{color:var(--muted)}
    .where{
      margin-top:10px;
      display:flex;flex-wrap:wrap;gap:8px;align-items:center
    }
    .pill{
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(11,18,32,0.04);font-size:12px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 8px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(11,18,32,0.14);
      background:rgba(11,18,32,0.04);
      white-space:nowrap;
    }
    .chip.tba{
      border-color: rgba(245,158,11,0.35);
      background: rgba(245,158,11,0.12);
    }
    .chip.auto{
      border-color: rgba(16,185,129,0.35);
      background: rgba(16,185,129,0.12);
    }
    .chip.src{
      border-color: rgba(59,130,246,0.35);
      background: rgba(59,130,246,0.10);
    }

    .empty{
      padding:26px;text-align:center;color:var(--muted);
      background:transparent;border:1px dashed var(--line);border-radius:var(--radius);
      margin-top:16px;
    }
    .footer{
      margin:18px 2px 0;color:var(--muted);font-size:12px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>Grenland Live</h1>
        <div class="sub">Matcher & events â€“ leser JSON fra <span class="muted">/data</span></div>
      </div>

      <div class="controls">
        <div class="ctrl">
          <label for="leagueSel">Liga</label>
          <select id="leagueSel">
            <option value="__all__">Alle</option>
          </select>
        </div>

        <div class="ctrl">
          <label for="daysSel">Periode</label>
          <select id="daysSel">
            <option value="7">Neste 7 dager</option>
            <option value="14">Neste 14 dager</option>
            <option value="30" selected>Neste 30 dager</option>
            <option value="90">Neste 90 dager</option>
            <option value="365">Neste 365 dager</option>
          </select>
        </div>

        <div class="ctrl">
          <label for="q">SÃ¸k (lag/arena/pub)</label>
          <input id="q" placeholder="f.eks. Odd, Arsenal, Gimle..." />
        </div>

        <button class="btn" id="refreshBtn" title="Oppdater">â†» Oppdater</button>
        <div id="netStatus" class="status">â€¦</div>
      </div>
    </div>

    <div class="footer">
      <div class="small" id="lastUpdated">Lasterâ€¦</div>
      <div class="small" id="counts">â€¦</div>
    </div>

    <div id="list" class="grid"></div>
    <div id="empty" class="empty" style="display:none;">Ingen treff i valgt periode / filter.</div>
  </div>

<script>
/* ---------------------------------------------------------
   Grenland Live â€“ komplett index.html (auto-fallback + TBA)
   Legg JSON-filer i /data/*.json i samme repo.
---------------------------------------------------------- */

const TZ = "Europe/Oslo";
const MS_DAY = 24 * 60 * 60 * 1000;

// âœ… Kildeliste (tilpass stier hvis du bruker andre filnavn)
const SOURCES = [
  { key:"eliteserien", name:"Eliteserien",    path:"data/eliteserien.json" },
  { key:"obos",       name:"OBOS-ligaen",     path:"data/obos.json" },
  { key:"premier",    name:"Premier League",  path:"data/premier_league.json" },
  { key:"laliga",     name:"La Liga",         path:"data/laliga.json" }
];

// âœ… Default-kanaler (fixer â€œKanal ikke oppgitt i dataâ€ automatisk)
const DEFAULT_CHANNELS = {
  "Premier League": "Viaplay / V Sport",
  "La Liga": "TV 2 Play",
  "Eliteserien": "TV 2 / TV 2 Play",
  "OBOS-ligaen": "TV 2 Play"
};

let ALL = [];          // normaliserte events
let LEAGUES = [];      // unike ligaer
let LAST_FETCH = null;

function setNetStatus(){
  const el = document.getElementById("netStatus");
  if (!el) return;
  const online = navigator.onLine;
  el.textContent = online ? "ðŸŸ¢ Online" : "ðŸ”´ Offline";
  el.classList.toggle("online", online);
  el.classList.toggle("offline", !online);
}

function fmtOslo(iso){
  const d = new Date(iso);
  return d.toLocaleString("no-NO", {
    timeZone: TZ,
    weekday:"short",
    year:"numeric",
    month:"2-digit",
    day:"2-digit",
    hour:"2-digit",
    minute:"2-digit"
  });
}

// Robust: prÃ¸ver flere felt + flere formater
function pickKickoff(obj){
  const candidates = [
    obj.kickoff, obj.start, obj.datetime, obj.date, obj.kick_off, obj.time
  ];
  for (const c of candidates){
    if (!c) continue;
    if (typeof c === "string" && c.trim()){
      const s = c.trim();
      // Hvis bare dato (YYYY-MM-DD), sett til TBA (vi lar det bli TBA)
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return null;
      const d = new Date(s);
      if (!isNaN(d.getTime())) return d.toISOString(); // standardiser
    }
  }
  return null;
}

// Pen TBA-tekst for tid
function prettyTimeOrTBA(iso){
  if (!iso || typeof iso !== "string") return { text: "TBA (tid kommer)", isTBA: true };
  const d = new Date(iso);
  if (isNaN(d.getTime())) return { text: "TBA (tid kommer)", isTBA: true };
  return { text: fmtOslo(iso), isTBA: false };
}

// Kanal med auto-fallback + merking
function channelWithFallback(game){
  const raw = (game.channel || game.tv || "").toString().trim();
  if (raw) return { text: raw, isAuto: false };

  const league = (game.league || game.competition || "").toString().trim();
  const fallback = DEFAULT_CHANNELS[league];
  if (fallback) return { text: fallback, isAuto: true };

  return { text: "Kanal ikke oppgitt", isAuto: false };
}

// Hent JSON (tÃ¥ler GitHub Pages cache ved Ã¥ legge pÃ¥ ?v=timestamp)
async function fetchJson(path){
  const bust = `?v=${Date.now()}`;
  const res = await fetch(path + bust, { cache:"no-store" });
  if (!res.ok) throw new Error(`HTTP ${res.status} for ${path}`);
  return await res.json();
}

// Normaliserer ulike JSON-strukturer til Ã©n liste
function normalize(source, json){
  const games = Array.isArray(json) ? json
             : Array.isArray(json.games) ? json.games
             : Array.isArray(json.matches) ? json.matches
             : Array.isArray(json.items) ? json.items
             : [];

  const out = [];

  for (const g of games){
    const league = (g.league || g.competition || source.name || "").toString().trim() || "Ukjent liga";
    const home  = (g.home || g.homeTeam || g.team1 || "").toString().trim();
    const away  = (g.away || g.awayTeam || g.team2 || "").toString().trim();
    const title = (g.title || "").toString().trim();

    // teams/text
    let teamsText = "";
    if (home && away) teamsText = `${home} â€“ ${away}`;
    else if (title) teamsText = title;
    else teamsText = [home, away].filter(Boolean).join(" â€“ ") || "Kamp";

    const kickoffIso = pickKickoff(g); // null => TBA
    const timeInfo = prettyTimeOrTBA(kickoffIso);

    const chanInfo = channelWithFallback({ ...g, league });

    const whereList =
      Array.isArray(g.where) ? g.where :
      Array.isArray(g.pubs) ? g.pubs.map(p => p.name || p) :
      Array.isArray(g.venues) ? g.venues :
      [];

    out.push({
      sourceKey: source.key,
      sourceName: source.name,
      league,
      home,
      away,
      teamsText,
      kickoffIso,          // kan vÃ¦re null
      timeText: timeInfo.text,
      isTBA: timeInfo.isTBA,
      channel: chanInfo.text,
      channelAuto: chanInfo.isAuto,
      where: whereList.filter(Boolean).map(x => (typeof x === "string" ? x : JSON.stringify(x))),
      raw: g
    });
  }

  return out;
}

function inNextDays(isoOrNull, days){
  // TBA: vis alltid (du vil fortsatt se kampen i lista)
  if (!isoOrNull) return true;

  const now = new Date();
  const d = new Date(isoOrNull);
  if (isNaN(d.getTime())) return true;
  return (d.getTime() - now.getTime()) <= (days * MS_DAY) && (d.getTime() + MS_DAY) >= now.getTime();
}

function sortByKickoff(a,b){
  // TBA nederst
  if (!a.kickoffIso && !b.kickoffIso) return a.teamsText.localeCompare(b.teamsText, "no");
  if (!a.kickoffIso && b.kickoffIso) return 1;
  if (a.kickoffIso && !b.kickoffIso) return -1;

  return new Date(a.kickoffIso).getTime() - new Date(b.kickoffIso).getTime();
}

function uniq(arr){
  return Array.from(new Set(arr));
}

function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function render(){
  const list = document.getElementById("list");
  const empty = document.getElementById("empty");
  const leagueSel = document.getElementById("leagueSel").value;
  const days = parseInt(document.getElementById("daysSel").value, 10);
  const q = document.getElementById("q").value.trim().toLowerCase();

  let items = ALL.slice();

  // league filter
  if (leagueSel !== "__all__"){
    items = items.filter(x => x.league === leagueSel);
  }

  // days filter (TBA passes)
  items = items.filter(x => inNextDays(x.kickoffIso, days));

  // search
  if (q){
    items = items.filter(x => {
      const hay = [
        x.league, x.teamsText, x.home, x.away, x.channel,
        ...(x.where || []),
        x.sourceName
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }

  // sort
  items.sort(sortByKickoff);

  // render
  list.innerHTML = "";
  if (!items.length){
    empty.style.display = "block";
  } else {
    empty.style.display = "none";
    for (const g of items){
      const card = document.createElement("div");
      card.className = "card";

      const timeChip = g.isTBA ? `<span class="chip tba">TBA</span>` : ``;
      const autoChip = g.channelAuto ? `<span class="chip auto">auto</span>` : ``;
      const srcChip  = `<span class="chip src">${escapeHtml(g.sourceName)}</span>`;

      const whereHtml = (g.where && g.where.length)
        ? `<div class="where"><span class="muted" style="font-size:12px;font-weight:700;">Hvor:</span> ${g.where.map(w => `<span class="pill">${escapeHtml(w)}</span>`).join("")}</div>`
        : ``;

      card.innerHTML = `
        <div class="rowTop">
          <div class="title">
            <div class="league">${escapeHtml(g.league)}</div>
            <div class="teams">${escapeHtml(g.teamsText)}</div>
          </div>

          <div class="meta">
            <div class="metaLine">
              <span class="metaLabel">ðŸ•’</span>
              <span>${escapeHtml(g.timeText)}</span>
              ${timeChip}
            </div>

            <div class="metaLine">
              <span class="metaLabel">ðŸ“º</span>
              <span>${escapeHtml(g.channel)}</span>
              ${autoChip}
            </div>

            <div class="metaLine">
              ${srcChip}
            </div>
          </div>
        </div>

        ${whereHtml}
      `;

      list.appendChild(card);
    }
  }

  // footer stats
  const counts = document.getElementById("counts");
  const tbaCount = items.filter(x => x.isTBA).length;
  const autoCount = items.filter(x => x.channelAuto).length;
  counts.textContent = `Viser ${items.length} â€¢ TBA: ${tbaCount} â€¢ auto-kanal: ${autoCount}`;
}

function fillLeagueDropdown(){
  const sel = document.getElementById("leagueSel");
  const current = sel.value || "__all__";
  sel.innerHTML = `<option value="__all__">Alle</option>` +
    LEAGUES.map(l => `<option value="${escapeHtml(l)}">${escapeHtml(l)}</option>`).join("");
  sel.value = LEAGUES.includes(current) ? current : "__all__";
}

async function loadAll(){
  setNetStatus();
  const lastUpdated = document.getElementById("lastUpdated");
  lastUpdated.textContent = "Laster JSONâ€¦";

  const all = [];
  const errors = [];

  for (const src of SOURCES){
    try{
      const json = await fetchJson(src.path);
      const norm = normalize(src, json);
      all.push(...norm);
    } catch (e){
      errors.push(`${src.name}: ${e.message}`);
    }
  }

  ALL = all;
  LEAGUES = uniq(ALL.map(x => x.league)).sort((a,b) => a.localeCompare(b, "no"));
  fillLeagueDropdown();

  LAST_FETCH = new Date();
  const oslo = LAST_FETCH.toLocaleString("no-NO", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });

  if (errors.length){
    lastUpdated.textContent = `Oppdatert ${oslo} â€¢ Noen kilder feilet: ${errors.join(" | ")}`;
  } else {
    lastUpdated.textContent = `Oppdatert ${oslo}`;
  }

  render();
}

function wire(){
  window.addEventListener("online", () => { setNetStatus(); });
  window.addEventListener("offline", () => { setNetStatus(); });

  document.getElementById("leagueSel").addEventListener("change", render);
  document.getElementById("daysSel").addEventListener("change", render);
  document.getElementById("q").addEventListener("input", () => {
    // liten debounce
    clearTimeout(window.__qT);
    window.__qT = setTimeout(render, 120);
  });

  document.getElementById("refreshBtn").addEventListener("click", loadAll);
}

wire();
loadAll();
</script>
</body>
</html>
