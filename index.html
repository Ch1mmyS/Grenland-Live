// app.js — Grenland Live (2026 fixed loader)
// ✅ Uses ONLY data/2026/*.json
// ✅ Sport always opens even if some files 404
// ✅ Errors shown in #errorBox (non-blocking)

const TZ = "Europe/Oslo";

// 2026 paths (your current repo structure)
const PATHS_2026 = {
  football: "data/2026/football.json",
  handball_men: "data/2026/handball_men.json",
  handball_women: "data/2026/handball_women.json",
  wintersport_men: "data/2026/wintersport_men.json",
  wintersport_women: "data/2026/wintersport_women.json",

  // existing content/events (kept)
  pubs: "data/content/pubs.json",
  events: "data/events/events.json"
};

function $(id){ return document.getElementById(id); }

function show(el){ el.classList.remove("hidden"); }
function hide(el){ el.classList.add("hidden"); }

function setActiveTab(tab){
  ["tabSport","tabPuber","tabEvents"].forEach(id=>{
    const b = $(id);
    if (!b) return;
    b.classList.toggle("active", b.dataset.tab === tab);
  });
}

function fmtOslo(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleString("no-NO", {
      timeZone: TZ,
      weekday: "short",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit"
    });
  }catch{
    return iso || "";
  }
}

async function fetchJson(path){
  const res = await fetch(path, { cache: "no-store" });
  if (!res.ok) throw new Error(`${path}: ${res.status}`);
  return await res.json();
}

async function fetchJsonSafe(path, label){
  try{
    const data = await fetchJson(path);
    return { ok:true, data };
  }catch(e){
    return { ok:false, data:null, error: `${label}: ${e.message}` };
  }
}

function clearError(){
  const box = $("errorBox");
  if (!box) return;
  box.textContent = "";
  box.classList.remove("show");
}

function showError(lines){
  const box = $("errorBox");
  if (!box) return;
  if (!lines || !lines.length){
    clearError();
    return;
  }
  box.textContent = "⚠️ Kunne ikke laste:\n" + lines.join(" • ");
  box.classList.add("show");
}

function normalizeItems(doc){
  if (!doc) return [];
  if (Array.isArray(doc.items)) return doc.items;
  if (Array.isArray(doc.games)) return doc.games;
  return [];
}

function renderList(items, renderer){
  const list = $("list");
  list.innerHTML = "";
  if (!items.length){
    list.innerHTML = `<div class="item"><div class="itemTitle">Ingen treff</div><div class="meta">Ingen data tilgjengelig.</div></div>`;
    return;
  }
  items.forEach(it => list.appendChild(renderer(it)));
}

// ---------- Modal ----------
function openModal(item){
  const back = $("modalBack");
  $("modalTitle").textContent = (item.home && item.away) ? `${item.home} – ${item.away}` : (item.title || "Event");
  $("modalTime").textContent = item.start ? fmtOslo(item.start) : "Ukjent";
  $("modalChannel").textContent = item.channel || "Ukjent";

  const pubs = Array.isArray(item.where) ? item.where : [];
  const wrap = $("modalPubs");
  wrap.innerHTML = "";
  (pubs.length ? pubs : ["Vikinghjørnet", "Gimle Pub"]).forEach(p=>{
    const tag = document.createElement("span");
    tag.className = "tag";
    tag.textContent = p;
    wrap.appendChild(tag);
  });

  back.classList.add("show");
  back.setAttribute("aria-hidden", "false");
}

function closeModal(){
  const back = $("modalBack");
  back.classList.remove("show");
  back.setAttribute("aria-hidden", "true");
}

function wireModal(){
  $("modalClose").addEventListener("click", closeModal);
  $("modalBack").addEventListener("click", (e)=>{
    if (e.target.id === "modalBack") closeModal();
  });
  document.addEventListener("keydown",(e)=>{
    if (e.key === "Escape") closeModal();
  });
}

// ---------- Views ----------
async function showSport(){
  $("panelH2").textContent = "Sport";
  $("panelMeta").textContent = "2026-feed (data/2026/*.json)";
  clearError();

  const errors = [];

  const football = await fetchJsonSafe(PATHS_2026.football, "Fotball");
  if (!football.ok) errors.push(football.error);

  const hbMen = await fetchJsonSafe(PATHS_2026.handball_men, "Håndball (menn)");
  if (!hbMen.ok) errors.push(hbMen.error);

  const hbWomen = await fetchJsonSafe(PATHS_2026.handball_women, "Håndball (damer)");
  if (!hbWomen.ok) errors.push(hbWomen.error);

  const wsMen = await fetchJsonSafe(PATHS_2026.wintersport_men, "Vintersport (menn)");
  if (!wsMen.ok) errors.push(wsMen.error);

  const wsWomen = await fetchJsonSafe(PATHS_2026.wintersport_women, "Vintersport (kvinner)");
  if (!wsWomen.ok) errors.push(wsWomen.error);

  showError(errors);

  // default: football list
  const items = normalizeItems(football.data)
    .sort((a,b)=> new Date(a.start) - new Date(b.start))
    .slice(0, 250);

  renderList(items, (it)=>{
    const div = document.createElement("div");
    div.className = "item clickable";
    div.innerHTML = `
      <div class="itemTop">
        <div class="itemTitle">${(it.home && it.away) ? `${it.home} – ${it.away}` : (it.title || "Event")}</div>
        <div class="meta">${it.start ? fmtOslo(it.start) : ""}</div>
      </div>
      <div class="tagRow">
        <span class="tag">${it.league || "Ukjent"}</span>
        <span class="tag">${it.channel || "Ukjent kanal"}</span>
      </div>
    `;
    div.addEventListener("click", ()=> openModal(it));
    return div;
  });
}

async function showPuber(){
  $("panelH2").textContent = "Puber";
  $("panelMeta").textContent = "data/content/pubs.json";
  clearError();

  const r = await fetchJsonSafe(PATHS_2026.pubs, "Puber");
  if (!r.ok){
    showError([r.error]);
    renderList([], ()=>document.createElement("div"));
    return;
  }
  const pubs = normalizeItems(r.data);
  renderList(pubs, (p)=>{
    const div = document.createElement("div");
    div.className = "item";
    const name = p.name || p.title || "Pub";
    const city = p.city || "";
    div.innerHTML = `
      <div class="itemTop">
        <div class="itemTitle">${name}</div>
        <div class="meta">${city}</div>
      </div>
    `;
    return div;
  });
}

async function showEvents(){
  $("panelH2").textContent = "Eventer";
  $("panelMeta").textContent = "data/events/events.json";
  clearError();

  const r = await fetchJsonSafe(PATHS_2026.events, "Eventer");
  if (!r.ok){
    showError([r.error]);
    renderList([], ()=>document.createElement("div"));
    return;
  }
  const events = normalizeItems(r.data)
    .sort((a,b)=> new Date(a.start||a.date||0) - new Date(b.start||b.date||0))
    .slice(0, 250);

  renderList(events, (ev)=>{
    const div = document.createElement("div");
    div.className = "item";
    const title = ev.title || ev.name || "Event";
    const when = ev.start || ev.date || "";
    div.innerHTML = `
      <div class="itemTop">
        <div class="itemTitle">${title}</div>
        <div class="meta">${when ? fmtOslo(when) : ""}</div>
      </div>
      <div class="tagRow">
        ${ev.location ? `<span class="tag">${ev.location}</span>` : ""}
      </div>
    `;
    return div;
  });
}

// ---------- Navigation ----------
function goApp(tab){
  hide($("home"));
  show($("app"));
  setActiveTab(tab);

  // reset search
  const q = $("q");
  if (q) q.value = "";

  if (tab === "sport") showSport();
  if (tab === "puber") showPuber();
  if (tab === "events") showEvents();
}

function goHome(){
  hide($("app"));
  show($("home"));
  clearError();
}

// ---------- Wire ----------
document.addEventListener("DOMContentLoaded", ()=>{
  wireModal();

  // Forside menu
  document.querySelectorAll("[data-go]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      goApp(btn.dataset.go);
    });
  });

  // Tabs inne i app
  $("tabSport").addEventListener("click", ()=> goApp("sport"));
  $("tabPuber").addEventListener("click", ()=> goApp("puber"));
  $("tabEvents").addEventListener("click", ()=> goApp("events"));

  // Back buttons
  $("backHome").addEventListener("click", goHome);
  $("backHome2").addEventListener("click", goHome);
});
